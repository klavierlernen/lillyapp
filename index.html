<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Lilly • Web App</title>

  <!-- Icons + Supabase -->
  <script src="https://unpkg.com/feather-icons"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <!-- Design -->
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

    :root{
      --bg:#ffffff;            /* weiß, neutralisiert */
      --surface:#ffffff;
      --text:#111827;
      --muted:#6b7280;
      --accent:#3A6FF8;
      --accent-2:#111827;      /* dunkler Buttonstil wie im Login-Frame */
      --success:#16a34a;
      --danger:#dc2626;
      --radius-xl:28px;
      --radius-lg:20px;
      --radius-md:14px;
      --shadow-lg:0 18px 40px rgba(0,0,0,.08);
      --shadow:0 8px 24px rgba(0,0,0,.06);
      --container:980px;
    }

    *{box-sizing:border-box}
    html,body{
      margin:0; height:100%;
      font-family:'Inter',system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      background:#fff; color:var(--text);
    }

    /* ========== LOGIN (Unicorn-Layout) ========== */
    #loginScreen{
      min-height:100dvh;
      display:block;
      padding:0;
    }
    .login-wrap{
      width:100%;
      height:100vh;
      display:flex;
      flex-direction:column;
      background:var(--surface);
      border-radius:0;
      overflow:hidden;
      box-shadow:none;
    }
    /* linkes Panel: Illustration */
    .login-hero{
      position:relative;
      background:#E8E4FF; /* lavendel wie im Referenzbild */
      display:flex; align-items:flex-end; justify-content:center;
      padding:0 24px;
      isolation:isolate;
      height:40vh;
    }
    .login-hero img{
      width:min(520px,92%);
      height:auto; object-fit:contain; display:block;
      transform: translateY(12px);
    }
    /* weiße Welle */
    .login-hero::after{
      content:""; position:absolute; left:0; right:0; bottom:-1px; height:180px;
      background:var(--surface);
      border-top-left-radius:70% 60%;
      border-top-right-radius:70% 60%;
      z-index:0;
    }

    /* rechtes Panel: Formular */
    .login-form{
      padding:56px 42px;
      display:flex; flex-direction:column; justify-content:center;
      gap:18px; z-index:1;
      height:60vh;
    }
    .login-title{
      font-size:2.1rem; font-weight:800; letter-spacing:.2px; margin:0 0 4px;
    }
    .login-sub{ color:var(--muted); margin:0 0 18px; }

    .input{
      appearance:none; border:1.5px solid #e5e7eb; background:#fff;
      border-radius:14px; padding:14px 16px; font-size:1rem; outline:none;
      transition:border .2s, box-shadow .2s;
    }
    .input:focus{ border-color:var(--accent); box-shadow:0 0 0 4px rgba(58,111,248,.15); }

    .btn-primary{
      border:none; cursor:pointer; border-radius:999px; padding:14px 18px;
      font-weight:700; color:#fff; background:var(--accent-2);
      box-shadow:0 10px 24px rgba(17,24,39,.18);
      transition:transform .12s ease, opacity .12s ease, box-shadow .2s;
    }
    .btn-primary:hover{ transform:translateY(-1px); box-shadow:0 14px 30px rgba(17,24,39,.24); }
    .login-hint{ color:var(--muted); font-size:.94rem; text-align:center; margin-top:6px; }
    .login-hint b{ color:var(--text); }

    #loginError{ color:var(--danger); font-weight:600; display:none; margin-top:4px; }

    /* Responsive Login */
    @media (max-width:900px){
      .login-wrap{
        flex-direction:column;
        width:100%;
        height:100vh;
        display:flex;
      }
      .login-hero{ min-height:0; height:40vh; }
      .login-hero::after{ height:80px; }
      .login-form{ padding:36px 22px 42px; height:60vh; }
    }

    /* ========== APP HEADER / MAIN (Your Tasks) ========== */
    header.app{
      display:none; /* erst nach Login sichtbar */
      position:sticky; top:0; z-index:20;
      background:var(--surface);
      box-shadow:var(--shadow);
      padding:18px 22px;
    }
    .app-row{
      width:min(100%, var(--container));
      margin:0 auto;
      display:flex; align-items:center; justify-content:space-between;
    }
    .brand{
      display:flex; align-items:center; gap:12px; font-weight:800; font-size:1.6rem;
    }
    .brand i{ color:var(--accent); }

    /* Searchbar */
    .searchbar{
      width:min(100%, var(--container));
      margin:12px auto 0;
      padding:10px 14px;
      background:#fff; border-radius:14px;
      box-shadow:0 1px 6px rgba(0,0,0,.05);
      display:flex; align-items:center; gap:10px;
    }
    .searchbar input{
      border:none; outline:none; flex:1; font-size:1rem; background:transparent; color:var(--text);
    }
    .searchbar i{ color:#9ca3af; }

    /* Sections */
    .app-section{
      width:min(100%, var(--container)); margin:24px auto;
      padding:0 16px;
    }
    .section-title{
      font-size:1.8rem; font-weight:800; margin:8px 0 12px;
      letter-spacing:.2px;
    }

    /* Card Grid im Task-Stil */
    .grid{
      display:grid; gap:18px;
      grid-template-columns:1fr;
    }
    @media (min-width:720px){
      .grid{ grid-template-columns:1fr 1fr; }
    }

    .task-card{
      position:relative;
      background:var(--surface);
      border-radius:22px;
      box-shadow:var(--shadow);
      padding:18px 18px 18px 18px;
      display:flex; gap:14px; align-items:center;
      cursor:pointer; transition:transform .12s ease, box-shadow .2s ease;
    }
    .task-card:hover{ transform:translateY(-2px); box-shadow:0 14px 32px rgba(0,0,0,.08); }

    .task-badge{
      flex:0 0 auto;
      background:#111827; color:#fff; font-weight:700;
      border-radius:10px; padding:8px 10px; min-width:42px; text-align:center;
    }
    .task-content{
      flex:1 1 auto;
    }
    .task-title{ margin:0; font-size:1.15rem; font-weight:800; }
    .task-sub{ margin:4px 0 0; color:var(--muted); font-size:.97rem; line-height:1.5; }

    .task-illustr{
      width:84px; height:84px; border-radius:18px; background:#f3f4f6;
      display:flex; align-items:center; justify-content:center; overflow:hidden;
    }
    .task-illustr img{ width:74px; height:auto; }

    /* Buttonsleiste in Karten (deine existierenden Aktionen) */
    .card-buttons{
      display:none; gap:10px; margin-top:12px; justify-content:flex-end;
    }
    .task-card.expanded .card-buttons{ display:flex; }
    .chip-btn{
      border:none; border-radius:10px; padding:8px 12px; background:#f3f4f6;
      font-weight:600; cursor:pointer; transition:background .2s,color .2s;
    }
    .chip-btn.accept:hover{ background:var(--success); color:#fff; }
    .chip-btn.decline:hover{ background:var(--danger); color:#fff; }

    /* Admin Panel clean */
    #adminPanel{
      display:none; width:min(100%,var(--container)); margin:26px auto 60px; padding:0 16px;
    }
    #adminPanel .grid{ grid-template-columns:repeat(auto-fit,minmax(180px,1fr)); }
    .user-card{
      background:#fff; border-radius:16px; box-shadow:var(--shadow); padding:14px; text-align:center; font-weight:600;
    }

    /* Utility */
    .hidden{display:none!important}
  </style>
</head>
<body>

  <!-- ========== LOGIN SCREEN ========== -->
  <section id="loginScreen" aria-label="Login">
    <div class="login-wrap">
      <div class="login-hero">
        <!-- Ersetz das Bild durch dein eigenes -->
        <img src="/unicorn.png" alt="Lillya Illustration" />
      </div>
      <form class="login-form" onsubmit="return false;">
        <h1 class="login-title">Login</h1>
        <p class="login-sub">Willkommen zurück bei Lilly.</p>

        <!-- Wir bleiben bei 4-stelliger PIN, stilistisch aber wie E-Mail-Feld -->
        <input id="pinInput" class="input" type="password" inputmode="numeric" maxlength="4" placeholder="4-stellige PIN" autocomplete="one-time-code" />
        <button id="loginBtn" class="btn-primary" type="button">Login</button>
        <div id="loginError">PIN ungültig oder nicht gefunden.</div>

        <p class="login-hint">Du hast noch kein Konto? <b>Sign Up</b></p>
      </form>
    </div>
  </section>

  <!-- ========== APP HEADER ========== -->
  <header class="app" id="appHeader" role="banner">
    <div class="app-row">
      <div class="brand"><i data-feather="target"></i> Your Tasks</div>
      <i data-feather="menu"></i>
    </div>
    <div class="searchbar">
      <i data-feather="search"></i>
      <input placeholder="Search" aria-label="Search tasks" />
    </div>
  </header>

  <!-- ========== SECTIONS (binden deine Grids ein) ========== -->
  <main id="appMain" class="hidden" role="main">
    <!-- Daily Challenges -> pendingGrid -->
    <section class="app-section">
      <h2 class="section-title">Daily Challenges</h2>
      <div class="grid" id="pendingGrid"></div>
    </section>

    <!-- One Time -> upcomingGrid -->
    <section class="app-section">
      <h2 class="section-title">One Time</h2>
      <div class="grid" id="upcomingGrid"></div>
    </section>

    <!-- Hinweis wenn keine Pending -->
    <p id="noPendingMsg" class="hidden" style="text-align:center; color:var(--muted);">Keine ausstehenden Aufgaben</p>

    <!-- Adminbereich -->
    <div id="adminPanel">
      <h2 class="section-title" style="margin-top:0;">Benutzerübersicht</h2>
      <section class="grid" id="userGrid"></section>
    </div>
  </main>

  <!-- Template für Karten (visuell im Task-Stil) -->
  <template id="card-template">
    <article class="task-card">
      <div class="task-badge">16</div>
      <div class="task-content">
        <h3 class="task-title"></h3>
        <p class="task-sub"></p>
        <div class="card-buttons">
          <button class="chip-btn accept" title="Annehmen"><i data-feather="check-circle"></i></button>
          <button class="chip-btn decline" title="Ablehnen"><i data-feather="x-circle"></i></button>
          <button class="chip-btn withdraw" title="Zurückziehen"><i data-feather="corner-up-left"></i></button>
          <button class="chip-btn edit-entry" title="Bearbeiten"><i data-feather="edit-3"></i></button>
        </div>
      </div>
      <div class="task-illustr">
        <!-- optional Illustration pro Typ -->
        <img alt="illustration" src="https://dummyimage.com/160x160/f3f4f6/aaaaaa.png&text=%F0%9F%90%BE" />
      </div>
    </article>
  </template>

  <!-- ========== SCRIPT / FUNKTIONEN ========== -->
  <script>
    const supabase = window.supabase.createClient(
      "https://uewrybgyaanhjoyqpmky.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVld3J5Ymd5YWFuaGpveXFwbWt5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE3NjA2ODYsImV4cCI6MjA3NzMzNjY4Nn0.gTv68th-3S2hErX_Dp8RwjU3oZtQXLZFToLGUM5inT8"
    );

    const loginScreen  = document.getElementById('loginScreen');
    const appHeader    = document.getElementById('appHeader');
    const appMain      = document.getElementById('appMain');
    const pendingGrid  = document.getElementById('pendingGrid');
    const upcomingGrid = document.getElementById('upcomingGrid');
    const noPendingMsg = document.getElementById('noPendingMsg');
    const adminPanel   = document.getElementById('adminPanel');
    const userGrid     = document.getElementById('userGrid');

    feather.replace();

    // ---------- Karten-Renderer (Task-Stil) ----------
    function createCard(item, roleParam){
      const role = roleParam || (localStorage.getItem('role') || 'user').toLowerCase();
      const tpl = document.getElementById('card-template');
      const frag = tpl.content.cloneNode(true);
      const card = frag.querySelector('.task-card');

      // Badge: kleine Zahl, fallback 1
      frag.querySelector('.task-badge').textContent = (item.count || 1);

      // Titel/Unterzeile
      frag.querySelector('.task-title').textContent = item.typ || 'Ohne Typ';
      const details = [item.bereich, item.datum].filter(Boolean).join(' • ');
      frag.querySelector('.task-sub').textContent = item.beschreibung || details || 'Keine Beschreibung';

      // Buttons je nach Rolle
      const acceptBtn   = frag.querySelector('.accept');
      const declineBtn  = frag.querySelector('.decline');
      const withdrawBtn = frag.querySelector('.withdraw');
      const editBtn     = frag.querySelector('.edit-entry');

      if(role === 'admin'){ acceptBtn.style.display='none'; declineBtn.style.display='none'; }
      else { withdrawBtn.style.display='none'; editBtn.style.display='none'; }

      // expand/collapse: Buttons sichtbar machen
      card.addEventListener('click', (e)=>{
        if(e.target.closest('.card-buttons')) return;
        card.classList.toggle('expanded');
      });

      // Actions
      acceptBtn.addEventListener('click', (e)=>{ e.stopPropagation(); updateStatus(item.id,'approved'); });
      declineBtn.addEventListener('click', (e)=>{ e.stopPropagation(); updateStatus(item.id,'pending');  });
      withdrawBtn.addEventListener('click', async (e)=>{
        e.stopPropagation();
        if(confirm('Diesen Eintrag wirklich löschen?')){
          await supabase.from('Database').update({status:'deleted'}).eq('id', item.id);
          const pin = localStorage.getItem('id'); if(pin) loadCards(pin);
        }
      });
      editBtn.addEventListener('click', (e)=>{ e.stopPropagation(); openAdminForm(item); });

      feather.replace();
      return frag;
    }

    async function updateStatus(id,newStatus){
      const { error } = await supabase.from('Database').update({status:newStatus}).eq('id', id);
      if(!error){
        const pin = localStorage.getItem('id');
        if(pin) loadCards(pin);
      }
    }

    // ---------- Daten laden ----------
    async function loadCards(pin){
      pendingGrid.innerHTML = ''; upcomingGrid.innerHTML = '';
      noPendingMsg.classList.add('hidden');

      let data, error;
      try{
        if((localStorage.getItem('role')||'user') === 'admin'){
          const res = await supabase.from('Database').select('*').eq('connected_user_A', pin);
          data = res.data; error = res.error;
        }else{
          const res = await supabase.from('Database').select('*').ilike('id', `${pin}_%`);
          data = res.data; error = res.error;
        }
      }catch(err){ error = err; }

      if(error){
        pendingGrid.innerHTML = `<p style="color:#dc2626">Fehler beim Laden: ${error.message || error}</p>`;
        return;
      }
      if(!data || data.length===0){
        noPendingMsg.classList.remove('hidden');
        return;
      }

      const pending  = data.filter(d=>d.status==='pending');
      const approved = data.filter(d=>d.status==='approved');

      if(pending.length===0){ noPendingMsg.classList.remove('hidden'); }
      pending.forEach(item => pendingGrid.appendChild(createCard(item)));

      approved.forEach(item => upcomingGrid.appendChild(createCard(item)));

      feather.replace();
    }

    // ---------- Admin Helfer ----------
    async function loadUsers(){
      userGrid.innerHTML = '<p style="text-align:center;color:var(--muted)">Lade Benutzer…</p>';
      const {data, error} = await supabase.from('Database').select('UserName, id').not('id','is',null);
      if(error){ userGrid.innerHTML = `<p style="color:#dc2626">${error.message}</p>`; return; }
      userGrid.innerHTML='';
      const unique = [...new Map((data||[]).map(u=>[u.id,u])).values()];
      unique.forEach(u=>{
        const div = document.createElement('div');
        div.className = 'user-card';
        div.textContent = `${u.UserName} (${u.id})`;
        userGrid.appendChild(div);
      });
    }

    function addAdminButton(){
      if(document.querySelector('.edit-fab')) return;
      const fab = document.createElement('button');
      fab.className = 'btn-primary edit-fab';
      fab.style.position='fixed'; fab.style.right='22px'; fab.style.bottom='24px';
      fab.style.padding='12px 16px'; fab.style.borderRadius='14px'; fab.style.zIndex='40';
      fab.innerHTML = '<i data-feather="edit-3"></i>&nbsp;Eintrag';
      fab.onclick = ()=>openAdminForm();
      document.body.appendChild(fab);
      feather.replace();
      adminPanel.style.display='block';
      loadUsers();
    }

    async function openAdminForm(existing){
      if(document.getElementById('adminForm')) return;
      const wrap = document.createElement('div');
      wrap.id='adminForm';
      wrap.innerHTML = `
        <div style="position:fixed;inset:0;background:#0006;z-index:70" id="backdrop"></div>
        <div style="position:fixed;z-index:80;left:50%;top:50%;transform:translate(-50%,-50%);background:#fff;border-radius:16px;box-shadow:var(--shadow-lg);width:min(92vw,520px);padding:20px">
          <h3 style="margin:0 0 12px;font-weight:800">Dienst ${existing?'bearbeiten':'anlegen'}</h3>
          <label>Benutzer</label>
          <select id="userSelect" class="input" style="width:100%;margin-bottom:10px"></select>
          <label>Datum</label>
          <input id="datumInput" type="date" class="input" />
          <label>Typ</label>
          <input id="typInput" class="input" placeholder="Typ" />
          <label>Bereich</label>
          <input id="bereichInput" class="input" placeholder="Bereich" />
          <label>Beschreibung</label>
          <textarea id="beschreibungInput" class="input" placeholder="Beschreibung" rows="3"></textarea>
          <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:12px">
            <button id="cancelNew" class="chip-btn">Abbrechen</button>
            <button id="saveNew" class="btn-primary">${existing?'Änderungen speichern':'Speichern'}</button>
          </div>
        </div>`;
      document.body.appendChild(wrap);

      const {data: users} = await supabase.from('Database').select('UserName,id').not('id','is',null);
      const filtered = (users||[]).filter(u=>u.id && u.id.length===4);
      const sel = document.getElementById('userSelect');
      ([...new Map(filtered.map(u=>[u.id,u])).values()]).forEach(u=>{
        const opt=document.createElement('option'); opt.value=u.id; opt.textContent=`${u.UserName} (${u.id})`; sel.appendChild(opt);
      });

      if(existing){
        document.getElementById('datumInput').value = existing.datum || '';
        document.getElementById('typInput').value = existing.typ || '';
        document.getElementById('bereichInput').value = existing.bereich || '';
        document.getElementById('beschreibungInput').value = existing.beschreibung || '';
        document.getElementById('saveNew').dataset.editId = existing.id;
      }

      const close = ()=>wrap.remove();
      document.getElementById('backdrop').onclick = close;
      document.getElementById('cancelNew').onclick = close;

      document.getElementById('saveNew').onclick = async ()=>{
        const userId = sel.value;
        const datum = document.getElementById('datumInput').value;
        const typ   = document.getElementById('typInput').value.trim();
        const bereich = document.getElementById('bereichInput').value.trim();
        const beschreibung = document.getElementById('beschreibungInput').value.trim();
        if(!userId || !datum || !typ || !bereich || !beschreibung) return;

        const btn = document.getElementById('saveNew');
        if(btn.dataset.editId){
          await supabase.from('Database').update({datum,typ,bereich,beschreibung}).eq('id', btn.dataset.editId);
        }else{
          const creatorPin = localStorage.getItem('id');
          let creatorName = 'Unbekannt';
          const {data:cData} = await supabase.from('Database').select('UserName').eq('id', creatorPin).single();
          if(cData && cData.UserName) creatorName = cData.UserName;
          const randomPart = Math.floor(100000 + Math.random()*900000);
          const id = `${userId}_${randomPart}`;
          await supabase.from('Database').insert([{ id, datum, typ, bereich, beschreibung, connected_user_A: creatorPin, UserName: creatorName, status:'pending' }]);
        }
        close();
        const pin=localStorage.getItem('id'); if(pin) loadCards(pin);
      };
    }

    // ---------- Login ----------
    document.getElementById('loginBtn').addEventListener('click', async ()=>{
      const pin = (document.getElementById('pinInput').value || '').trim();
      const err = document.getElementById('loginError');
      if(pin.length!==4){ err.style.display='block'; return; }
      err.style.display='none';

      // Tabelle "Database" ist die Usersource für die PIN
      const {data:userData, error} = await supabase.from('Database').select('*').eq('id', pin).limit(1);
      if(error || !userData || userData.length===0){ err.style.display='block'; return; }

      const user = userData[0];
      localStorage.setItem('id', pin);
      localStorage.setItem('role', user.role || 'user');

      // UI umschalten
      loginScreen.style.display = 'none';
      appHeader.style.display = 'block';
      appMain.classList.remove('hidden');

      // Admin
      if((user.role||'user') === 'admin'){ addAdminButton(); } else { const fab=document.querySelector('.edit-fab'); if(fab) fab.remove(); adminPanel.style.display='none'; }

      // Daten laden
      await loadCards(pin);

      // Realtime (Database)
      let reloadTimeout;
      supabase.channel('live-updates')
        .on('postgres_changes', {event:'*', schema:'public', table:'Database'},
          async (payload)=>{
            if(reloadTimeout) clearTimeout(reloadTimeout);
            reloadTimeout = setTimeout(async ()=>{
              const currentPin = localStorage.getItem('id');
              if(currentPin) await loadCards(currentPin);
            }, 400);
          })
        .subscribe();
    });

    // Enter auf PIN
    document.getElementById('pinInput').addEventListener('keydown', e=>{
      if(e.key==='Enter'){ e.preventDefault(); document.getElementById('loginBtn').click(); }
    });
  </script>
</body>
</html>
